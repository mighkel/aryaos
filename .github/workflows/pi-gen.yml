name: Build AryaOS Image

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build-aryaos:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Initialize submodules
        run: |
          git submodule update --init --recursive
          if [ ! -d "pi-gen" ]; then
            echo "pi-gen submodule missing, cloning manually..."
            git clone --depth 1 https://github.com/RPi-Distro/pi-gen.git
          fi
          echo "=== pi-gen directory check ==="
          ls -la pi-gen/

      - name: Free up disk space
        run: |
          sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-chrome-stable firefox powershell mono-devel libgl1-mesa-dri
          sudo apt-get autoremove -y
          sudo apt-get autoclean
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          df -h

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-user-static \
            binfmt-support \
            debian-archive-keyring \
            debootstrap \
            zip \
            dosfstools \
            build-essential \
            git \
            wget \
            curl \
            quilt \
            libarchive-tools \
            arch-test
          
          sudo systemctl enable --now binfmt-support
          sudo update-binfmts --enable qemu-aarch64 || true
          sudo update-binfmts --enable qemu-arm || true

      - name: Apply build fixes
        run: |
          echo "=== Applying build fixes ==="
          
          # Fix shared files path in config
          sed -i 's|SHARED_FILES="$(pwd)/../shared_files"|SHARED_FILES="$(pwd)/shared_files"|' config
          
          # Remove missing packages from pi-gen
          sed -i '/^rpi-swap$/d' pi-gen/stage2/01-sys-tweaks/00-packages || true
          sed -i '/^rpi-loop-utils$/d' pi-gen/stage2/01-sys-tweaks/00-packages || true
          sed -i '/^rpi-swap rpi-loop-utils$/d' pi-gen/stage2/01-sys-tweaks/00-packages || true
          
          # Apply package fixes to all stage files
          ./scripts/fix-packages.sh
          
          echo "=== SHARED_FILES setting ==="
          grep SHARED_FILES config

      - name: Build AryaOS image
        run: |
          echo "=== Starting AryaOS build ==="
          chmod +x build.sh
          export DEBIAN_FRONTEND=noninteractive
          
          echo "=== Directory structure ==="
          ls -la
          echo "=== Shared files ==="
          ls -la shared_files/ || echo "No shared_files directory"
          
          timeout 150m sudo -E ./build.sh || {
            echo "=== Build failed or timed out ==="
            find pi-gen/work -name "*.log" -exec tail -100 {} \; 2>/dev/null || true
            exit 1
          }

      - name: Check build results
        if: always()
        run: |
          sudo chown -R runner:runner pi-gen/work/ 2>/dev/null || true
          echo "=== Generated files ==="
          find . -name "*.img" -o -name "*.zip" -ls 2>/dev/null || echo "No images found"
          echo "=== Deploy directory ==="
          ls -la pi-gen/deploy/ 2>/dev/null || echo "No deploy directory"
          echo "=== Build logs ==="
          find pi-gen/work -name "*.log" -exec echo "=== {} ===" \; -exec tail -50 {} \; 2>/dev/null || true

      - name: Fix permissions for artifacts
        if: always()
        run: |
          sudo chown -R runner:runner pi-gen/ 2>/dev/null || true
          sudo chown -R runner:runner . 2>/dev/null || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: aryaos-build-${{ github.run_number }}
          path: |
            pi-gen/deploy/*.img
            pi-gen/deploy/*.zip
            pi-gen/work/*/build.log
          retention-days: 30

      - name: Upload debug logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: aryaos-debug-logs-${{ github.run_number }}
          path: |
            pi-gen/work/
            config
            build.sh
          retention-days: 7
